<!DOCTYPE html>
<html>
  <head>
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
      <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
      <title>Mijndert Stuij - Generate CloudFormation templates using Python</title>
      <meta name="description" content="Consulting AWS engineer and proponent of simplicity with a focus on highly scalable cloud infrastructure" />
      <meta name="HandheldFriendly" content="True" />
      <meta name="MobileOptimized" content="320" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="/favicon.ico">
      <meta name="google-site-verification" content="saUIHjzun9dAGQ4-YTEb0W_vLiFRM1sEiHZXPCCOmyc" />
      <link rel="alternate" type="application/rss+xml" title="Mijndert Stuij" href="https://mijndertstuij.nl/feed.xml">
  </head>
  <body class="home-template">
      <header class="main-header post-header no-cover">
    <div class="vertical">
        <div class="main-header-content inner">
            <h1 class="page-title">Generate CloudFormation templates using Python</h1>
            <p class="nav">
  <a href="/">Home</a>
  <a href="/about/">About</a>
  <a href="/uses/">Uses</a>
  <a href="/now/">Now</a>
  <a href="mailto:mijndert@mijndertstuij.nl">AMA</a>
</p>

        </div>
    </div>
</header>

<main class="content" role="main">

    <article class="post">

        <header class="post-header">
            <section class="post-meta">
                <time class="post-date" datetime="2015-11-10">10 Nov 2015</time>
                
            </section>
        </header>

        <section class="post-content">
            <p><a href="https://github.com/cloudtools/troposphere">Troposphere</a> is a Python library which makes it easier to write and maintain <a href="https://aws.amazon.com/cloudformation/">CloudFormation</a> templates. From the README:</p>

<blockquote>
  <p>The troposphere library allows for easier creation of the AWS CloudFormation JSON by writing Python code to describe the AWS resources. Troposphere also includes some basic support for OpenStack resources via heat.</p>
</blockquote>

<blockquote>
  <p>To facilitate catching CloudFormation or JSON errors early the library has property and type checking built into the classes.</p>
</blockquote>

<!-- more -->

<p>Troposphere can be easily installed inside a <a href="http://docs.python-guide.org/en/latest/dev/virtualenvs/">virtualenv</a> with <em>pip install troposphere</em>. It’s also probably a good idea to make sure you can <a href="http://mijndertstuij.nl/quickly-switch-accounts-using-aws-cli/">switch AWS accounts</a> quickly on the CLI. This is needed when we want to run Ansible playbooks against CloudFormation. More on that later.</p>

<p>Let’s get to some examples.</p>

<h3 id="imports">Imports</h3>

<p>Every Troposphere file has to start with a few <em>imports</em> and a description.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">troposphere</span> <span class="kn">import</span> <span class="n">Base64</span><span class="p">,</span> <span class="n">GetAtt</span><span class="p">,</span> <span class="n">GetAZs</span><span class="p">,</span> <span class="n">If</span><span class="p">,</span> <span class="n">Select</span><span class="p">,</span> <span class="n">Join</span><span class="p">,</span> <span class="n">Output</span><span class="p">,</span> <span class="n">Parameter</span><span class="p">,</span> <span class="n">Ref</span><span class="p">,</span> <span class="n">Template</span><span class="p">,</span> <span class="n">Tags</span>
<span class="kn">from</span> <span class="nn">troposphere</span> <span class="kn">import</span> <span class="n">rds</span><span class="p">,</span> <span class="n">ec2</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s">'Mijndert Stuij'</span>

<span class="k">def</span> <span class="nf">GenerateRDSInstance</span><span class="p">():</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">Template</span><span class="p">()</span>

    <span class="n">t</span><span class="o">.</span><span class="n">add_description</span><span class="p">(</span><span class="s">"RDS instance in existing VPC"</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="params">Params</h3>

<p>After that we will put in a few <em>params</em> which we will with data using Ansible later on. Here’s a parameter for the name of the CloudFormation stack.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">stackname_param</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">(</span><span class="n">Parameter</span><span class="p">(</span>
    <span class="s">"stackname"</span><span class="p">,</span>
    <span class="n">Description</span><span class="o">=</span><span class="s">"Environment Name (default: StackNameNotDefined)"</span><span class="p">,</span>
    <span class="n">Type</span><span class="o">=</span><span class="s">"String"</span><span class="p">,</span>
    <span class="n">Default</span><span class="o">=</span><span class="s">"StackNameNotDefined"</span><span class="p">,</span>
<span class="p">))</span>
</code></pre></div></div>

<p>And here’s a param for the name of a database. Notice the constraints we can use.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dbname</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">(</span><span class="n">Parameter</span><span class="p">(</span>
    <span class="s">"dbname"</span><span class="p">,</span>
    <span class="n">Default</span><span class="o">=</span><span class="s">"MyDatabase"</span><span class="p">,</span>
    <span class="n">Description</span><span class="o">=</span><span class="s">"The database name"</span><span class="p">,</span>
    <span class="n">Type</span><span class="o">=</span><span class="s">"String"</span><span class="p">,</span>
    <span class="n">MinLength</span><span class="o">=</span><span class="s">"1"</span><span class="p">,</span>
    <span class="n">MaxLength</span><span class="o">=</span><span class="s">"64"</span><span class="p">,</span>
    <span class="n">AllowedPattern</span><span class="o">=</span><span class="s">"[a-zA-Z][a-zA-Z0-9]*"</span><span class="p">,</span>
    <span class="n">ConstraintDescription</span><span class="o">=</span><span class="p">(</span><span class="s">"must begin with a letter and contain only"</span>
                           <span class="s">" alphanumeric characters."</span><span class="p">)</span>
<span class="p">))</span>
</code></pre></div></div>

<h3 id="creating-an-rds-instance">Creating an RDS instance</h3>

<p>Here’s an example of a Troposphere template which will create a CloudFormation JSON file that will launch an RDS instance. We’ll give the RDS a name, assign some storage and a subnet, and we will say that its engine should be MySQL 5.6.</p>

<p>Notice the <em>ref</em> being used in some places. You can <em>ref</em> to a <em>param</em> to get its value returned.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">rdsinstance</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">rds</span><span class="o">.</span><span class="n">DBInstance</span><span class="p">(</span>
    <span class="s">"rdsinstance"</span><span class="p">,</span>
    <span class="n">DBName</span><span class="o">=</span><span class="n">Ref</span><span class="p">(</span><span class="n">dbname</span><span class="p">),</span>
    <span class="n">AllocatedStorage</span><span class="o">=</span><span class="n">Ref</span><span class="p">(</span><span class="n">dballocatedstorage</span><span class="p">),</span>
    <span class="n">DBInstanceClass</span><span class="o">=</span><span class="n">Ref</span><span class="p">(</span><span class="n">dbclass</span><span class="p">),</span>
    <span class="n">Engine</span><span class="o">=</span><span class="s">"MySQL"</span><span class="p">,</span>
    <span class="n">EngineVersion</span><span class="o">=</span><span class="s">"5.6"</span><span class="p">,</span>
    <span class="n">MasterUsername</span><span class="o">=</span><span class="n">Ref</span><span class="p">(</span><span class="n">dbuser</span><span class="p">),</span>
    <span class="n">MasterUserPassword</span><span class="o">=</span><span class="n">Ref</span><span class="p">(</span><span class="n">dbpassword</span><span class="p">),</span>
    <span class="n">DBSubnetGroupName</span><span class="o">=</span><span class="n">Ref</span><span class="p">(</span><span class="n">dbsubnetgroup</span><span class="p">),</span>
    <span class="n">VPCSecurityGroups</span><span class="o">=</span><span class="p">[</span><span class="n">Ref</span><span class="p">(</span><span class="n">dbsecuritygroup</span><span class="p">)],</span>
    <span class="n">MultiAZ</span><span class="o">=</span><span class="s">"True"</span><span class="p">,</span>
    <span class="n">AutoMinorVersionUpgrade</span><span class="o">=</span><span class="s">"False"</span><span class="p">,</span>
    <span class="n">BackupRetentionPeriod</span><span class="o">=</span><span class="s">"7"</span><span class="p">,</span>
    <span class="n">StorageType</span><span class="o">=</span><span class="s">"gp2"</span>
<span class="p">))</span>
</code></pre></div></div>

<h3 id="outputs">Outputs</h3>

<p>CloudFormation allows us to give some output after CloudFormation is done doing its business. In this case we will <em>join</em> some data together to create a JDBC connection string. You can copy-paste this into the configuration of your application, obviously.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">t</span><span class="o">.</span><span class="n">add_output</span><span class="p">(</span><span class="n">Output</span><span class="p">(</span>
    <span class="s">"JDBCConnectionString"</span><span class="p">,</span>
    <span class="n">Description</span><span class="o">=</span><span class="s">"JDBC connection string for database"</span><span class="p">,</span>
    <span class="n">Value</span><span class="o">=</span><span class="n">Join</span><span class="p">(</span><span class="s">""</span><span class="p">,</span> <span class="p">[</span>
        <span class="s">"jdbc:mysql://"</span><span class="p">,</span>
        <span class="n">GetAtt</span><span class="p">(</span><span class="s">"rdsinstance"</span><span class="p">,</span> <span class="s">"Endpoint.Address"</span><span class="p">),</span>
        <span class="s">":"</span><span class="p">,</span>
        <span class="n">GetAtt</span><span class="p">(</span><span class="s">"rdsinstance"</span><span class="p">,</span> <span class="s">"Endpoint.Port"</span><span class="p">),</span>
        <span class="s">"/"</span><span class="p">,</span>
        <span class="n">Ref</span><span class="p">(</span><span class="n">dbname</span><span class="p">)</span>
    <span class="p">])</span>
<span class="p">))</span>
</code></pre></div></div>

<h3 id="return-json">Return JSON</h3>

<p>Notice how in the beginning of this tutorial we did <code class="highlighter-rouge">t = Template()</code>? To generate the CloudFormation JSON file we’ll need to write the result of our Troposphere code to valid JSON. Troposphere will do this for us, of course.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">return</span> <span class="n">t</span>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">GenerateRDSInstance</span><span class="p">()</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">'../cfm/rds.json'</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">to_json</span><span class="p">()))</span>
    <span class="k">print</span> <span class="s">"JSON written"</span>
</code></pre></div></div>

<h3 id="results">Results</h3>

<p>Here’s the results of our hard work:</p>

<ul>
  <li><a href="https://gist.github.com/mijndert/9e0587f6b188f641def7">Troposphere template</a></li>
  <li><a href="https://gist.github.com/mijndert/c6af61fed8b6427313dc">CloudFormation JSON</a></li>
</ul>

<p>Some documentation on functions can be found on <a href="http://nullege.com/codes/search/troposphere">Nullege</a>.</p>

<h3 id="ansible">Ansible</h3>

<p>To make it easy to fill in the blanks on those <em>params</em> I use Ansible. Ansible can talk to CloudFormation to either run new CloudFormation stacks, or destroy them completely.</p>

<p>This is the last step in this tutorial. Again, Ansible will fill in our <em>params</em> using Ansible’s <em>vars</em> function and then we tell Ansible to run a CloudFormation task using our JSON file.</p>

<p>This allows you to run the same JSON file again and again by just changing some variables in an Ansible playbook.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#</span>
<span class="c1"># ansible-playbook -i localhost-inventory ansible/rds.yml</span>
<span class="c1">#</span>
<span class="nn">---</span>
<span class="pi">-</span> <span class="na">hosts</span><span class="pi">:</span> <span class="s">localhost</span>
  <span class="na">connection</span><span class="pi">:</span> <span class="s">local</span>
  <span class="na">gather_facts</span><span class="pi">:</span> <span class="s">False</span>
  <span class="na">vars</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">account</span><span class="pi">:</span> <span class="s2">"</span><span class="s">MyAccountName"</span>
  <span class="pi">-</span> <span class="na">stackname</span><span class="pi">:</span> <span class="s2">"</span><span class="s">RDS"</span>
  <span class="pi">-</span> <span class="na">dbname</span><span class="pi">:</span> <span class="s2">"</span><span class="s">myDatabase"</span>
  <span class="pi">-</span> <span class="na">dbuser</span><span class="pi">:</span> <span class="s2">"</span><span class="s">myUser"</span>
  <span class="pi">-</span> <span class="na">dbpassword</span><span class="pi">:</span> <span class="s2">"</span><span class="s">myPassword"</span>
  <span class="pi">-</span> <span class="na">dbclass</span><span class="pi">:</span> <span class="s2">"</span><span class="s">db.t2.small"</span>
  <span class="pi">-</span> <span class="na">dballocatedstorage</span><span class="pi">:</span> <span class="s2">"</span><span class="s">5"</span>
  <span class="pi">-</span> <span class="na">sourcesg</span><span class="pi">:</span> <span class="s2">"</span><span class="s">sg-1234567"</span>
  <span class="na">vars_files</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">../var/MyAccountName.yml</span>
  <span class="na">tasks</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Run rds cfm template</span>
    <span class="na">cloudformation</span><span class="pi">:</span>
      <span class="na">stack_name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
      <span class="na">state</span><span class="pi">:</span> <span class="s">present</span>
      <span class="na">region</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
      <span class="na">template</span><span class="pi">:</span> <span class="s2">"</span><span class="s">../cfm/rds.json"</span>
      <span class="na">template_parameters</span><span class="pi">:</span>
        <span class="na">stackname</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
        <span class="na">vpcid</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
        <span class="na">prsubnets</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
        <span class="na">pusubnets</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
        <span class="na">dbname</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
        <span class="na">dbuser</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
        <span class="na">dbpassword</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
        <span class="na">dbclass</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
        <span class="na">dballocatedstorage</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
        <span class="na">sourcesg</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
      <span class="na">tags</span><span class="pi">:</span>
        <span class="na">Stackname</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
        <span class="na">Customer</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Company</span><span class="nv"> </span><span class="s">Ltd."</span>
    <span class="na">register</span><span class="pi">:</span> <span class="s">rds</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">show output</span>
    <span class="na">debug</span><span class="pi">:</span> <span class="s">var=rds</span>
</code></pre></div></div>

        </section>

    </article>

</main>

      <footer class="site-footer clearfix">
        <section class="copyright">
          <a href="/">Mijndert Stuij</a> &copy;
            2018 &bull; All rights reserved.
        </section>
        <section class="poweredby">
          Made with Jekyll using a modified <a href="http://github.com/rosario/kasper">Kasper theme</a>
        </section>
      </footer>
  </body>
  <link rel="stylesheet" type="text/css" href="/assets/css/style.css" />
  <link rel="stylesheet" type="text/css" href="/assets/css/custom.css" />
  <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />
</html>
