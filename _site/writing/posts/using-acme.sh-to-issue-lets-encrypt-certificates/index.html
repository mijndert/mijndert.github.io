<!DOCTYPE html>
<html>
  <head>
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
      <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
      <title>Mijndert Stuij - Using Acme.sh to issue Let's Encrypt certificates</title>
      <meta name="description" content="Consulting AWS engineer and proponent of simplicity with a focus on highly scalable cloud infrastructure" />
      <meta name="HandheldFriendly" content="True" />
      <meta name="MobileOptimized" content="320" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="/favicon.ico">
      <meta name="google-site-verification" content="saUIHjzun9dAGQ4-YTEb0W_vLiFRM1sEiHZXPCCOmyc" />
      <link rel="alternate" type="application/rss+xml" title="Mijndert Stuij" href="https://mijndertstuij.nl/feed.xml">
  </head>
  <body class="home-template">
      <header class="main-header post-header no-cover">
    <div class="vertical">
        <div class="main-header-content inner">
            <h1 class="page-title">Using Acme.sh to issue Let's Encrypt certificates</h1>
            <p class="nav">
  <a href="/">Home</a>
  <a href="/about/">About</a>
  <a href="/uses/">Uses</a>
  <a href="/now/">Now</a>
  <a href="mailto:mijndert@mijndertstuij.nl">AMA</a>
</p>

        </div>
    </div>
</header>

<main class="content" role="main">

    <article class="post">

        <header class="post-header">
            <section class="post-meta">
                <time class="post-date" datetime="2017-03-14">14 Mar 2017</time>
                
            </section>
        </header>

        <section class="post-content">
            <p>Some time ago <a href="https://mijndertstuij.nl/writing/posts/letsencrypt-ssl-nginx/">I wrote about</a> how to use <a href="https://letsencrypt.org/">Let’s Encrypt</a> certificates to get an A+ on the <a href="https://www.ssllabs.com/ssltest/">SSL Labs test</a>. Back then the only way to obtain and manage certificates was <a href="https://certbot.eff.org/">CertBot</a>. I always thought that solution made it a hassle to manage multiple certificates. My friend <a href="https://jorijn.com/">Jorijn</a> brought <a href="https://github.com/Neilpang/acme.sh">acme.sh</a> to my attention, a new way to issue and manage Let’s Encrypt certificates. It was time for me to revisit the topic. <!-- more --></p>

<h2 id="what-is-acmesh">What is acme.sh?</h2>

<p>Acme.sh is an ACME protocol client written purely in Shell (Unix shell) language so there are no dependencies other than having a shell (Bash, Dash, sh). It’s the simplest yet most complete way to manage Let’s Encrypt certificates.</p>

<h2 id="install">Install</h2>

<p>To install acme.sh you can wget or curl the script from the internet and execute it.</p>

<p><code class="highlighter-rouge">curl https://get.acme.sh | sh</code></p>

<p>Or</p>

<p><code class="highlighter-rouge">wget -O -  https://get.acme.sh | sh</code></p>

<p>Of course it’s a horrible idea to just execute a script on your machine using root credentials. Be sure to check out the script before and decide for yourself.</p>

<p>The script will:</p>

<ul>
  <li>Create and copy acme.sh to your home dir <code class="highlighter-rouge">($HOME): ~/.acme.sh/</code>. All certs will be placed in this folder too.</li>
  <li>Create alias for: <code class="highlighter-rouge">acme.sh=~/.acme.sh/acme.sh</code>.</li>
  <li>Create daily cron job to check and renew the certs if needed.</li>
</ul>

<p>You can also pull the code from git and execute the script from there:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/Neilpang/acme.sh.git
cd ./acme.sh
./acme.sh --install
</code></pre></div></div>

<p>You don’t have to be root but it is recommended.</p>

<h2 id="stateless">Stateless</h2>

<p>There are multiple ways to prove ownership of a domain using Acme.sh: standalone mode, using Apache or Nginx, DNS, or <a href="https://github.com/Neilpang/acme.sh/wiki/Stateless-Mode">stateless</a>. In my opinion the stateless mode is by far the easiest.</p>

<p>I’ve been using Nginx exclusively for 6 years so I’m going to give you the Nginx version. But this can also work with just about any webserver on the market today.</p>

<p>First get your account key thumbprint:</p>

<p><code class="highlighter-rouge">acme.sh --register-account</code></p>

<p>Now we can configure Nginx to return the account key thumbprint:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>server {
...
  location ~ "^/\.well-known/acme-challenge/([-_a-zA-Z0-9]+)$" {
    default_type text/plain;
    return 200 "$1.YOURTHUMBPRINT";
  }
...
}
</code></pre></div></div>

<p>Replace <code class="highlighter-rouge">YOURTHUMBPRINT</code> with the key that you got back when you registered. Restart Nginx after making these changes.</p>

<h2 id="issue--copy">Issue &amp; copy</h2>

<p>Issue a certificate for example.com:</p>

<p><code class="highlighter-rouge">acme.sh --issue -d example.com -d www.example.com  --stateless</code></p>

<p>Create a directory in which to copy your certificates for use by Nginx. I used <code class="highlighter-rouge">/etc/nginx/certificates</code> but you can use anything you like really.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>acme.sh --install-cert -d example.com \
--keypath       /etc/nginx/certificates/example.com.key  \
--fullchainpath /etc/nginx/certificates/example.com.pem \
--reloadcmd     "service nginx force-reload"
</code></pre></div></div>

<h2 id="configure-your-vhost">Configure your vhost</h2>

<p>Now we can insert the SSL certificate into your vhost:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>server {
...
  listen 443 ssl;
  listen [::]:443 ssl;

  ssl_certificate /etc/nginx/certificates/example.com.pem;
  ssl_certificate_key /etc/nginx/certificates/example.com.key;

  if ($scheme = http) {
    return 301 https://$server_name$request_uri;
  }
...
}
</code></pre></div></div>

<p>Take a look at my <a href="https://mijndertstuij.nl/writing/posts/letsencrypt-ssl-nginx/">previous article on this topic</a> for more information on how to configure Nginx for SSL usage.</p>

<h2 id="congratulations">Congratulations</h2>

<p>You now have a very easy way to issue new Let’s Encrypt certificates. Every certificate will automatically be renewed if needed so it’s fire-and-forgot from now on. Of course there’s way more options in Acme.sh than I could ever cover on my website, so please <a href="https://github.com/Neilpang/acme.sh/wiki">read the wiki</a>.</p>

        </section>

    </article>

</main>

      <footer class="site-footer clearfix">
        <section class="copyright">
          <a href="/">Mijndert Stuij</a> &copy;
            2018 &bull; All rights reserved.
        </section>
        <section class="poweredby">
          Made with Jekyll using a modified <a href="http://github.com/rosario/kasper">Kasper theme</a>
        </section>
      </footer>
  </body>
  <link rel="stylesheet" type="text/css" href="/assets/css/style.css" />
  <link rel="stylesheet" type="text/css" href="/assets/css/custom.css" />
  <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />
</html>
