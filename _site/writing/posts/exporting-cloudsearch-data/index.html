<!DOCTYPE html>
<html>
  <head>
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
      <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
      <title>Mijndert Stuij - Export and import AWS Cloudsearch data</title>
      <meta name="description" content="Consulting AWS engineer and proponent of simplicity with a focus on highly scalable cloud infrastructure" />
      <meta name="HandheldFriendly" content="True" />
      <meta name="MobileOptimized" content="320" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="/favicon.ico">
      <meta name="google-site-verification" content="saUIHjzun9dAGQ4-YTEb0W_vLiFRM1sEiHZXPCCOmyc" />
      <link rel="alternate" type="application/rss+xml" title="Mijndert Stuij" href="https://mijndertstuij.nl/feed.xml">
  </head>
  <body class="home-template">
      <header class="main-header post-header no-cover">
    <div class="vertical">
        <div class="main-header-content inner">
            <h1 class="page-title">Export and import AWS Cloudsearch data</h1>
            <p class="nav">
  <a href="/">Home</a>
  <a href="/about/">About</a>
  <a href="/uses/">Uses</a>
  <a href="/now/">Now</a>
  <a href="mailto:mijndert@mijndertstuij.nl">AMA</a>
</p>

        </div>
    </div>
</header>

<main class="content" role="main">

    <article class="post">

        <header class="post-header">
            <section class="post-meta">
                <time class="post-date" datetime="2016-04-01">01 Apr 2016</time>
                
            </section>
        </header>

        <section class="post-content">
            <p><a href="https://aws.amazon.com/cloudsearch/">AWS CloudSearch</a> is a highly scalable and reliable solution to implement search in your application or website. You can feed your search data into the service and never have to worry about performance or in any way scaling it to fit your needs. AWS CloudSearch supports about 34 languages and <a href="https://aws.amazon.com/cloudsearch/details/">features</a> such as highlighting, autocomplete and geospatial search.<!-- more --></p>

<p>One downside though is that there’s currently no easy way of exporting your data out of AWS CloudSearch. You might want to have the same exact data in your production account after playing with the service in your sandbox account. After a few tries I figured out how to export the data and import it back into a new CloudSearch domain.</p>

<p>I’m assuming you already have a new CloudSearch domain set up and ready to go.</p>

<h3 id="exporting-the-data">Exporting the data</h3>

<p>AWS CloudSearch can be accessed by HTTP(S) as you might already know. You can use that to our advantage to create some ugly output of our data.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://&lt;cloudsearch-domainname&gt;-&lt;cloudsearch-id&gt;.&lt;region&gt;.cloudsearch.amazonaws.com/2013-01-01/search?q<span class="o">=</span>matchall&amp;size<span class="o">=</span>600&amp;q.parser<span class="o">=</span>structured
</code></pre></div></div>

<p>You can find the first part of that URL in the AWS web console. Let’s break the other parts down.</p>

<p>You should append <code class="highlighter-rouge">2013-01-01</code> if you use the 2013 API version for CloudSearch. To get all results I used <code class="highlighter-rouge">search?q=matchall</code> followed by <code class="highlighter-rouge">&amp;size=600</code> to ask for 600 items. If you have more items change this number to the desired amount. To get actual structured JSON I pass <code class="highlighter-rouge">&amp;q.parser=structured</code> as the last argument.</p>

<p>Now that you have our results in a browser window (or curl) you can copy-paste this into a new JSON file, for example output.json.</p>

<h3 id="working-with-the-json">Working with the JSON</h3>

<p>Unfortunantly the JSON you have now isn’t yet ready to import back into CloudSearch. You need to modify a few things here and there.</p>

<h4 id="readability">Readability</h4>

<p>The make the JSON a little more readable you need to lint it. The fastest way I found is using a little utility called <a href="https://github.com/jmhodges/jsonpp">jsonpp</a>. You can install it on a Mac using <a href="http://brew.sh/">Homebrew</a> (<code class="highlighter-rouge">brew install jsonpp</code>).</p>

<p>To create a file with readable JSON you can do:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jsonpp output.json <span class="o">&gt;</span> output_pretty.json
</code></pre></div></div>

<h4 id="modifying-the-json-file">Modifying the JSON file</h4>

<ol>
  <li>First you need to get rid of the first part of the JSON, for me it looked something like this: <code class="highlighter-rouge">{"status":{"rid":"&lt;some ID&gt;","time-ms":2},"hits":{"found":576,"start":0,"hit":</code></li>
  <li>Now get rid of the last two curly brackets <code class="highlighter-rouge">}}</code></li>
  <li>Make sure the JSON has a <code class="highlighter-rouge">[</code> at the beginning and <code class="highlighter-rouge">]</code>at the end so it’s all one big array</li>
  <li>Use the search &amp; replace function of your editor to replace all occurrences <code class="highlighter-rouge">"fields": {</code> with <code class="highlighter-rouge">"type" : "add" ,"fields": {</code></li>
</ol>

<p>That last step is important because it tells CloudWatch you want to add these records to the domain.</p>

<h3 id="importing-the-data">Importing the data</h3>

<p>Now that you have our JSON all cleaned up you can start importing the data into our new CloudSearch domain using the AWS-CLI tools:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>aws cloudsearchdomain <span class="nt">--endpoint-url</span> https://&lt;cloudsearch-domainname&gt;-&lt;cloudsearch-id&gt;.&lt;region&gt;.cloudsearch.amazonaws.com upload-documents <span class="nt">--content-type</span> application/json <span class="nt">--documents</span> ./output_pretty.json
</code></pre></div></div>

        </section>

    </article>

</main>

      <footer class="site-footer clearfix">
        <section class="copyright">
          <a href="/">Mijndert Stuij</a> &copy;
            2018 &bull; All rights reserved.
        </section>
        <section class="poweredby">
          Made with Jekyll using a modified <a href="http://github.com/rosario/kasper">Kasper theme</a>
        </section>
      </footer>
  </body>
  <link rel="stylesheet" type="text/css" href="/assets/css/style.css" />
  <link rel="stylesheet" type="text/css" href="/assets/css/custom.css" />
  <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />
</html>
